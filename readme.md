# kubernetes-setup

Initial configuration for our shared Kubernetes cluster, deployed on Scaleway. For a full deployment example with CI, check out the [example-deployment](https://github.com/public-transport/example-deployment).

**Note that, if you deploy something on our cluster, you commit to the [code of conduct](./code-of-conduct.md).**

[![License](https://img.shields.io/github/license/public-transport/kubernetes-setup.svg?style=flat)](license)

This repository contains scripts to set up a Kubernetes cluster with

- an [nginx ingress](https://github.com/kubernetes/ingress-nginx) and [cert-manager](https://github.com/jetstack/cert-manager/) - allows you to deploy stuff that can be reached from your own domains, encrypted with certificates issued by [letsencrypt](letsencrypt.org).
- an EFK (elastic search, fluentd, kibana) stack - allows you to access and search logs in a web interface

To setup your own cluster, just connect to it and run all scripts in [`./initial-setup`](./initial-setup) in the order the files are numbered (start with `1-nginx-ingress.sh`).

## Users and permissions

Details on user and permissions management are documented [here](./users/readme.md).

## Logging

As mentioned above, we have an EFK stack running on our cluster for logging (if you don't know what that is, don't worry). Given you already have a `kubeconfig.yaml` with credentials to access the cluster (check [Users and permissions](#users-and-permissions) for details), you can connect to our Kibana (logging UI) instance by running

```bash
kubectl --kubeconfig <your-kubeconfig>.yaml port-forward service/kibana 5601:5601 --namespace=kube-logging
```

and opening `localhost:5601` in your web browser. Kibana is pretty overwhelming when you see it for the first time, it is a highly sophisticated UI to create any sort of index or metric on your logs. You might want to have a look at this [short introduction](https://www.elastic.co/guide/en/kibana/current/introduction.html).

For a basic starting point, you can select *Discover* in the sidebar on the left and enter `kubernetes.container_image: example-deployment` into the search field (replace `example-deployment` with the name of your own deployment, if you want). After you submit, you will see a very convoluted list of logs generated by our [example-deployment](https://github.com/public-transport/example-deployment). On the list of *available fields* on the left, you can now e.g. select `log`, which gives you a much simpler list of only the log messages and the corresponding time information.

**Warning: Keep in mind that logs are public for everyone who has access to the cluster, so don't log any sensitive information!**

## Contributing

If you found a bug or want to propose a feature, feel free to visit [the issues page](https://github.com/public-transport/kubernetes-setup/issues).
